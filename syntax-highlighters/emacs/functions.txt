;; paste this code to the end of your Doom "config.el" file!
;; --- L1VM Build & Lint Toolchain Configuration ---

(defvar l1vm-last-compiled-file nil
  "Stores the path of the file that was last passed to the compiler or linter.")

;; 1. The Build Function (SPC c c)
(defun l1vm/run-build ()
  "Runs the L1VM build script."
  (interactive)
  (let ((file-path (buffer-file-name))
        (file-base (file-name-sans-extension (file-name-nondirectory (buffer-file-name)))))
    (setq l1vm-last-compiled-file file-path)
    (compile (format "l1vm-build.sh %s" file-base))))

;; 2. The Lint Function (SPC c l)
(defun l1vm/run-lint ()
  "Runs the L1VM linter script."
  (interactive)
  (let ((file-path (buffer-file-name))
        (file-base (file-name-sans-extension (file-name-nondirectory (buffer-file-name)))))
    (setq l1vm-last-compiled-file file-path)
    (compile (format "l1vm-build-lint.sh %s" file-base))))

;; 3. Register Keybindings
(map! :leader
      (:prefix-map ("c" . "code")
       :desc "Run L1VM Build" "c" #'l1vm/run-build
       :desc "Run L1VM Linter" "l" #'l1vm/run-lint))

;; 4. Error Matcher for both (Build & Lint)
(with-eval-after-load 'compile
  (add-to-list 'compilation-error-regexp-alist 'l1vm-error-matcher)
  (add-to-list 'compilation-error-regexp-alist-alist
               `(l1vm-error-matcher
                 "\\(?:line:? \\|:\\|^\\|at \\)\\([0-9]+\\)"
                 ,(lambda () l1vm-last-compiled-file)
                 1)))
